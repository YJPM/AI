!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.AIAssistantExtension=n():t.AIAssistantExtension=n()}(this,function(){return function(){"use strict";var t={d:function(n,e){for(var i in e)t.o(e,i)&&!t.o(n,i)&&Object.defineProperty(n,i,{enumerable:!0,get:e[i]})},o:function(t,n){return Object.prototype.hasOwnProperty.call(t,n)}},n={};t.d(n,{default:function(){return a}});const e="typing_indicator",i={enabled:!0,showCharName:!0,animationEnabled:!0,customText:"正在输入",debug:!1,optionsGenEnabled:!1,optionsApiType:"openai",optionsApiKey:"",optionsApiModel:"gpt-4o-mini",optionsBaseUrl:"https://api.openai.com/v1",optionsTemplate:'\n# 角色\n你是一位拥有顶级创作能力的AI叙事导演。\n\n# 核心目标\n基于完整的聊天上下文，通过一个严谨的内部思考过程，为"我"（用户角色）生成3-5个接下来可能发生的、最具戏剧性的行动或事件选项。\n\n# 当前用户输入\n{{user_input}}\n\n# 角色信息\n{{char_card}}\n\n# 世界设定\n{{world_info}}\n\n# 内部思考过程\n1.  **[情境分析]**: 快速分析当前场景、我的情绪和目标、以及当前的冲突点。\n2.  **[选项构思]**: 基于分析，在内部构思多个多样化的选项（升级冲突、探索未知、反映内心、意外转折等）。\n3.  **[排序与决策]**: 根据戏剧性、角色一致性和叙事推动力，对构思的选项进行排序，将你认为的"最优选项"放在第一位。\n\n# 最终输出格式 (!!!至关重要!!!)\n- 你的最终输出必须是一个不换行的单行文本，包含3-5个高质量选项。\n- **第一个选项必须是你决策出的最优选项。**\n- 每个选项都必须用全角括号【】包裹。\n- **绝对禁止**包含任何序号、JSON、思考过程、解释或其他多余字符。\n\n# 对话上下文\n{{context}}\n\n# 开始执行导演任务，并输出你的最终选项列表：\n'.trim()},s=new class{constructor(){this.module=e}log(...t){this.isDebugEnabled()&&console.log(`[${this.module}]`,...t)}error(...t){console.error(`[${this.module}]`,...t)}warn(...t){console.warn(`[${this.module}]`,...t)}info(...t){this.isDebugEnabled()&&console.info(`[${this.module}]`,...t)}isDebugEnabled(){try{return!0===(window.getSettings?.()||{}).debug}catch(t){return!1}}async time(t,n){const e=performance.now();try{const i=await n(),s=performance.now()-e;return this.log(`${t} 完成，耗时: ${s.toFixed(2)}ms`),i}catch(n){const i=performance.now()-e;throw this.error(`${t} 失败，耗时: ${i.toFixed(2)}ms`,n),n}}};class o{constructor(){this.settings=null,this.extensionSettings=null}getSettings(){return null===this.settings&&this.loadSettings(),this.settings}loadSettings(){try{window.extension_settings&&window.extension_settings[e]?this.extensionSettings=window.extension_settings[e]:this.extensionSettings={},this.settings={...i};for(const t in i)void 0!==this.extensionSettings[t]&&(this.settings[t]=this.extensionSettings[t]);s.log("设置加载完成:",this.settings)}catch(t){s.error("加载设置失败:",t),this.settings={...i}}}saveSettings(t=null){try{t&&(this.settings={...this.settings,...t}),window.extension_settings&&(window.extension_settings[e]={...this.settings}),window.saveSettingsDebounced&&window.saveSettingsDebounced(),s.log("设置保存完成:",this.settings)}catch(t){s.error("保存设置失败:",t)}}updateSetting(t,n){this.settings[t]=n,this.saveSettings()}getSetting(t,n=null){return void 0!==this.settings[t]?this.settings[t]:n}resetSettings(){this.settings={...i},this.saveSettings(),s.log("设置已重置为默认值")}validateSettings(){const t=[],n=[];return!this.settings.optionsApiKey&&this.settings.optionsGenEnabled&&t.push("启用选项生成功能需要设置API密钥"),this.settings.optionsApiModel||t.push("需要设置API模型"),"openai"!==this.settings.optionsApiType||this.settings.optionsBaseUrl||t.push("OpenAI类型需要设置基础URL"),this.settings.debug&&n.push("调试模式已启用，可能影响性能"),{isValid:0===t.length,errors:t,warnings:n}}}const r=new class{constructor(){this.settingsManager=new o,this.isInitialized=!1}async initialize(){try{s.log("开始初始化AI助手扩展..."),await this.waitForCoreSystem(),this.settingsManager.loadSettings(),this.setupGlobalCompatibility(),this.isInitialized=!0,s.log("AI助手扩展初始化完成")}catch(t){s.error("扩展初始化失败:",t)}}async waitForCoreSystem(){return new Promise(t=>{const n=()=>{window.extension_settings&&window.eventSource&&window.event_types&&document.getElementById("chat")?t():setTimeout(n,100)};n()})}setupGlobalCompatibility(){window.getSettings=()=>this.settingsManager.getSettings()}getStatus(){return{initialized:this.isInitialized,settings:this.settingsManager.getSettings()}}cleanup(){s.log("AI助手扩展已清理")}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{r.initialize()}):r.initialize(),window.AIAssistantExtension=r;var a=r;return n.default}()});