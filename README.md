# AI智能助手

一个专注于智能选项生成的AI助手扩展，基于对话上下文自动生成高质量的后续对话选项。

## 主要功能

### 智能选项生成
- 基于对话上下文自动生成3-5个高质量选项建议
- 支持多种AI模型（OpenAI、Gemini等）
- 智能分析用户对话风格和偏好
- 提供手动和自动发送模式

### 手动模式多选功能
- **多选支持**：在手动模式下，可以点击多个选项进行组合
- **文本拼接**：选中的选项会以空格分隔自动拼接在输入框中
- **状态保持**：选项容器在发送消息后不会自动清除，可以继续使用
- **视觉反馈**：选中的选项会高亮显示，便于识别

### 透明底部快捷面板
- **透明背景**：底部快捷面板使用透明背景，不会遮挡界面内容
- **可控制显示**：通过扩展设置可以控制是否显示底部快捷面板
- **拖拽功能**：支持拖拽移动面板位置
- **自动折叠**：靠近右侧边缘时自动折叠，鼠标悬停时展开

### API拦截器功能
- **统一API配置**：让SillyTavern使用与扩展相同的API配置
- **解决兼容性问题**：当SillyTavern的API调用出现问题时，可以通过扩展的API配置来解决
- **可控制开关**：在扩展设置中可以启用或禁用API拦截器
- **自动格式转换**：支持OpenAI和Gemini格式之间的自动转换
- **CORS问题处理**：自动处理Google Gemini API的CORS限制，回退到SillyTavern原始API

### 代理系统功能
- **绕过CORS限制**：通过本地代理服务器绕过浏览器CORS限制
- **支持所有API**：支持Google Gemini、OpenAI等所有API的直接调用
- **流式响应**：支持流式响应处理，提供更好的用户体验
- **自动重连**：WebSocket连接断开时自动重连
- **错误处理**：完善的错误处理和日志记录

### 美观的提示样式
- 继承自打字指示器的动画效果
- 可自定义提示文本
- 支持动画开关控制
- 与主题完美融合

### 个性化设置
- 可配置API密钥和模型
- 自定义提示文本和样式
- 流式生成选项支持
- 调试模式开关
- 底部快捷面板显示控制

## 如何使用

1. 使用 URL 通过内置扩展管理器安装：https://github.com/gfdxvv596/TypingIndicator.git
2. 在扩展设置面板中找到"AI智能助手"并启用它
3. 配置API设置（如需要选项生成功能）
4. 设置发送模式：
   - **自动模式**：选择选项后立即发送消息
   - **手动模式**：支持多选，选中的选项拼接在输入框中
5. 自定义提示文本和样式
6. 控制底部快捷面板的显示状态

## 新功能说明

### 手动模式多选
- 将"发送模式"设置为"手动"
- 点击多个选项进行组合
- 选中的选项会高亮显示
- 所有选中的选项文本会拼接在输入框中
- 发送消息后选项状态重置，但选项容器保持显示

### 透明底部快捷面板
- 面板背景已设置为透明
- 在扩展设置中可以控制面板显示/隐藏
- 支持拖拽移动位置
- 靠近右侧时自动折叠

### API拦截器
- 在扩展设置中启用"API拦截器"选项
- 让SillyTavern使用与扩展相同的API配置
- 自动处理OpenAI和Gemini格式转换
- 解决SillyTavern API调用问题
- **注意**：使用Google Gemini API时，由于CORS限制，会自动回退到SillyTavern原始API

### 代理系统
- 在扩展设置中启用"代理系统"选项
- 需要先启动本地代理服务器（dark-server.js）
- 绕过浏览器CORS限制，支持直接调用Google Gemini API
- 提供流式响应支持，更好的用户体验
- 自动处理连接断开和重连

## 故障排除

### CORS错误（Google Gemini API）
如果遇到以下错误：
```
Access to fetch at 'https://generativelanguage.googleapis.com/v1/models/...' has been blocked by CORS policy
```

**解决方案：**
1. **推荐方案**：在SillyTavern设置中配置Gemini后端
2. **替代方案**：使用支持Gemini的OpenAI兼容代理服务
3. **临时方案**：将扩展API类型改为"OpenAI兼容"，使用Gemini代理
4. **禁用拦截器**：关闭API拦截器，让SillyTavern直接处理API调用

### 诊断工具
在浏览器控制台中可以使用以下命令进行诊断：
- `OptionsGenerator.diagnoseApiConfiguration()` - 诊断API配置
- `OptionsGenerator.diagnoseCorsIssue()` - 诊断CORS问题
- `OptionsGenerator.testApiConnection()` - 测试API连接
- `OptionsGenerator.initializeProxySystem()` - 初始化代理系统
- `OptionsGenerator.stopProxySystem()` - 停止代理系统

### 代理服务器设置
1. 确保已安装Node.js
2. 安装依赖：`npm install`
3. 启动代理服务器：
   - **简单启动**：`node dark-server.js` 或运行 `start-proxy.bat`
   - **管理工具**：运行 `manage-proxy.bat` 进行启动、停止、重启和状态检查
4. 服务器将在以下端口启动：
   - HTTP代理：http://127.0.0.1:8889
   - WebSocket：ws://127.0.0.1:9998

### 代理服务器管理
使用 `manage-proxy.bat` 可以方便地管理代理服务器：
- **启动服务器**：自动检查端口占用并处理冲突
- **停止服务器**：安全地终止所有相关进程
- **重启服务器**：先停止再启动，确保干净重启
- **状态检查**：查看当前服务器运行状态和进程信息

### 测试代理系统
可以使用 `test-proxy.html` 文件来测试代理系统是否正常工作：
1. 在浏览器中打开 `test-proxy.html`
2. 点击"测试连接"按钮
3. 如果连接成功，状态会显示为"已连接"
4. 可以点击"测试代理请求"来验证代理功能

## 许可证

AGPL-3.0 系列
